这个操作逻辑设计得完全错误，我们需要推倒重来，忽略目前代码中的所有不正确的流程。

让我们重新整理一下。一个工作闭环应该是这样的：

我们的会话不是Task而是Session。因此没有完成的概念。消息尽量不使用卡片消息，仅在需要按钮时使用。

1. 用户对Agent发送一条消息，默认是继续上一次会话。
   1. 使用 /new 或者 /clear 命令来启动新的会话
   2. 使用 /resume 或者 /list 来查看过去的会话列表，显示一个卡片消息，允许用户选择序号。在选择后更新这条消息内容为「已选择会话：……」
   3. 删去目前的/done命令。我们的操作逻辑要尽可能贴近Claude Code，它没有这个命令。
2. Agent接收到用户消息，开始返回或进行工作，此时发送一个「正在执行…」（可以有更多变体）的消息（这条消息在有任何下一条消息后需要撤回）
   1. 如果执行出错，发送一条错误消息
   2. 如果执行完成，发送结果的消息（Agent肯定会输出内容），飞书消息允许富文本。
   3. 如果有需要用户确认的内容，则发送一条卡片消息，卡片按钮应该是操作序号，序号对应的内容写到卡片正文里，在用户确认后这条消息更新为用户已选择的内容。
   4. 如果接收到/stop命令，如果有Agent在执行则终止，否则误操作
3. 保留 /help 命令
   1. 除了上面提到的命令外，只保留以下命令
      1. /plan 开启或关闭plan模式，操作完成后需要有反馈说当前是什么模式。另外，在plan模式下，「正在执行」前面应该标注是「Plan 模式」
      2. /info 展示关于本次Session的信息
      3. /model 切换模型，允许用户去选择模型，同样也是卡片按钮
